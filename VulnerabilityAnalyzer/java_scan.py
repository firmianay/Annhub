# -*- coding: utf_8 -*-
"""
通过对反编译java代码进行正则表达式匹配，获取下列内容：
    exec_path
    ip
    url
    uri
    email
"""

import os

def get_from_java(app_home):
    print("扫描反编译 java 代码")
    java_code = app_home+'/java_code'

    paths = os.popen('grep -rE "/acct/|/cache/|/data/|/dev/|/etc/|/init/|/mnt/|/proc/|/sbin/|/sdcard/|/sys/|/system/|/vendor/" %s | sort -u' % java_code).readlines()
    ips = os.popen('grep -rEo "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)" %s | cut -d ":" -f 2 | awk -F "." "NF==4" | sort -u' % java_code).readlines()
    urls = os.popen('grep -Ero "(http|https|ftp|ftps)://[a-zA-Z0-9./?=_-]*" %s | grep -Ev "(schemas.android.com|play.google.com)" | cut -d ":" -f 2-3 | sort -u | sort -u' % java_code).readlines()
    uris = os.popen('grep -rE "(file|javascript|data)://[a-zA-Z0-9./?=_-]*" %s | sort -u' % java_code).readlines()
    emails = os.popen('grep -rE "[\w.-]+@[\w-]+\.[\w.]+" %s | sort -u' % java_code).readlines()

    with open(app_home+'/java_scan.txt', 'w') as f:
        for path in paths:
            print(type(path))
            f.write("exec_path:" + ":".join(path.split("")))
        for ip in ips:
            f.write("ip:" + ip)
        for url in urls:
            f.write("url:" + url)
        for uri in uris:
            f.write("uri:" + uri)
        for email in emails:
            f.write("email:" + email)
        f.close()

    return paths, ips, urls, uris, emails
